#! /usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import argparse
import tarfile
from pathlib import Path
from importlib import import_module

sys.path.append(str(Path(__file__).parent.parent))
from pyviewerlib import debug, json_opts, type_config, args_chk, debug_print
from pyviewerlib.core.update import update


def get_filetype(fpath):
    ext = fpath.suffix[1:].lower()
    if tarfile.is_tarfile(fpath):
        return 'tar'
    else:
        for typ, exts in type_config.items():
            if ext in exts.split():
                return typ
    return None


def main(args):
    if args.file == 'update':
        update()
        return

    fpath = Path(args.file).expanduser()
    if not fpath.exists():
        print("file doesn't exists!")
        return
    if fpath.is_dir():
        print("{} is a directory.".format(fpath))
        return

    if not args_chk(args, 'type'):
        args.type = get_filetype(fpath)

    if args.type is None:
        print('This file type is not supported')
        return
    elif args.type == 'text':
        if ('LANG' in os.environ) and ('ja_JP' in os.environ['LANG']):
            print('vimでも使ってろ！')
        else:
            print("Why Don't you use vim???")
        return

    # python import style
    lib_path = "pyviewerlib.{}".format(args.type)
    # file path
    lib_path2 = Path(__file__).parent.parent/"pyviewerlib"
    lib_path2 /= "{}.py".format(args.type)
    if not lib_path2.is_file():
        print('Library file {} is not found.'.format(lib_path2))
        return
    try:
        lib = import_module(lib_path)
    except ImportError as e:
        print("Failed to load library")
        print('lib: {}'.format(lib_path2))
        print('error: {}'.format(e))
        return
    lib.main(fpath, args)
    return


if __name__ == "__main__":
    supported_type = list(type_config.keys()).copy()
    supported_type.remove('text')
    parser = argparse.ArgumentParser(description="show the constitution of a file. support file types ... {}".format(', '.join(supported_type)))
    parser.add_argument('file', help='input file / "pyviewer update" will update this file')
    parser.add_argument('-t', '--type', dest='type',
                        help='file type', choices=supported_type)
    parser.add_argument('-iv', '--image_viewer', help="set image viewer. supported args are 'matplotlib' (use matplotlib.pyplot.imshow), 'PIL' (use PIL.Image.show), 'OpenCV' (use cv2.imshow), and other string is treated as an external command (e.g. gosr, open).")
    parser.add_argument('--encoding', dest='encoding',
                        help='specify the encoding format in pickle and zip file.', type=str)
    parser.add_argument('--ask_password', '-p', action='store_true',
                        help='ask for the password for the file if needed.')
    ex_group = parser.add_mutually_exclusive_group()
    ex_group.add_argument('-v', '--verbose', dest='verbose',
                          action='store_true', help='show details')
    ex_group.add_argument('-k', '--key', dest='key', help='Dictionary key name in a pickle, path to a Group/Dataset in hdf5, a path to a file/dictionary in tar/zip, a table[/column[,column2...]] in sqlite3 or a key name in npz. If no key is specified, return the list of keys.', nargs='*')
    ex_group.add_argument('-i', '--interactive', dest='interactive',
                          help='open a file with interactive mode. support pickle, hdf5, tar, zip, sqlite3.', action='store_true')
    ex_group.add_argument('-c', '--interactive_cui', dest='cui',
                          help='open a file with interactive CUI mode. support hdf5, tar, zip, sqlite3.', action='store_true')
    if 'add_args' in json_opts:
        try:
            # additional arguments
            lib = import_module("pyviewerlib.{}".format(json_opts['add_args']))
        except ImportError as e:
            debug_print(e)
        else:
            lib.main(parser)
    args = parser.parse_args()

    args.debug = debug
    if not args_chk(args, 'image_viewer'):
        if 'image_viewer' in json_opts:
            args.image_viewer = json_opts['image_viewer']
    args.opts = json_opts
    main(args)

# vim: set filetype=python:
